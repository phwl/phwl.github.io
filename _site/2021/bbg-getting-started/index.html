<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.6 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>BeagleBone Green Getting Started - Life, the Universe and Fishing</title>
<meta name="description" content="How to get started with a BeagleBone Green (BBG)including installation, internet, GPIO, device tree, Si5351 interface via i2cand cross compiling the kernel.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Life, the Universe and Fishing">
<meta property="og:title" content="BeagleBone Green Getting Started">
<meta property="og:url" content="http://localhost:4000/2021/bbg-getting-started/">


  <meta property="og:description" content="How to get started with a BeagleBone Green (BBG)including installation, internet, GPIO, device tree, Si5351 interface via i2cand cross compiling the kernel.">



  <meta property="og:image" content="http://localhost:4000/assets/images/2021/02/bbg-photo.jpg">





  <meta property="article:published_time" content="2021-02-22T14:02:12+11:00">





  

  


<link rel="canonical" href="http://localhost:4000/2021/bbg-getting-started/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "phwl",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Life, the Universe and Fishing Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Life, the Universe and Fishing
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/archive" >Archive</a>
            </li><li class="masthead__menu-item">
              <a href="/gallery" >Gallery</a>
            </li><li class="masthead__menu-item">
              <a href="/research" >Research</a>
            </li><li class="masthead__menu-item">
              <a href="/about" >About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="BeagleBone Green Getting Started">
    <meta itemprop="description" content="How to get started with a BeagleBone Green (BBG)including installation, internet, GPIO, device tree, Si5351 interface via i2cand cross compiling the kernel.">
    <meta itemprop="datePublished" content="February 22, 2021">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">BeagleBone Green Getting Started
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#1-getting-started">1. Getting Started</a></li>
  <li><a href="#2-internet-connection">2. Internet Connection</a>
    <ul>
      <li><a href="#1-connecting-via-ethernet">1. Connecting via Ethernet</a>
        <ul>
          <li><a href="#11a-on-macos">1.1a. On MacOS</a></li>
          <li><a href="#11b-on-windows">1.1b. On Windows</a></li>
        </ul>
      </li>
      <li><a href="#2-connecting-via-wifi">2. Connecting via Wifi</a>
        <ul>
          <li><a href="#21-macos">2.1. MacOS</a></li>
          <li><a href="#22-windows-10">2.2. Windows 10</a></li>
        </ul>
      </li>
      <li><a href="#3-checking-connection">3. Checking Connection</a>
        <ul>
          <li><a href="#3-to-login-to-the-bbg-via-ethernet">3. To Login to the BBG via Ethernet</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#3-gpio">3. GPIO</a>
    <ul>
      <li><a href="#1-laboratory-experiment">1. Laboratory Experiment</a>
        <ul>
          <li><a href="#part-1---setup-10">Part 1 - Setup (10%)</a></li>
          <li><a href="#part-2---s2-button-input-30">Part 2 - S2 Button Input (30%)</a></li>
          <li><a href="#part-3---seven-segment-display-60">Part 3 - Seven Segment Display (60%)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#4-device-tree">4. Device Tree</a>
    <ul>
      <li><a href="#1-setting-pinmux-values-via-the-device-tree">1. Setting pinmux values via the Device Tree</a></li>
    </ul>
  </li>
  <li><a href="#5-si5351-interface-via-i2c">5. Si5351 interface via i2c</a>
    <ul>
      <li><a href="#1-i2c-interface-to-si5351">1. I2C Interface to Si5351</a></li>
      <li><a href="#2-linux-userspace-driver">2. Linux userspace driver</a></li>
      <li><a href="#3-programming-the-clock-generator">3. Programming the Clock Generator</a></li>
    </ul>
  </li>
  <li><a href="#4-laboratory-experiment">4. Laboratory Experiment</a>
      - {:.} <a href="#part-1---i2c-interface-30">Part 1 - I2C Interface (30%)</a>
      - {:.} <a href="#part-2---i2c-transaction-30">Part 2 - I2C Transaction (30%)</a>
      - {:.} <a href="#part-3---si5351-configuration-40">Part 3 - Si5351 Configuration (40%)</a></li>
  <li><a href="#6-cross-compiling-kernel">6. Cross-compiling Kernel</a>
    <ul>
      <li><a href="#1-introduction">1. Introduction</a></li>
      <li><a href="#2-reflash-the-emmc">2. Reflash the eMMC</a></li>
      <li><a href="#2-cross-compilation">2. Cross Compilation</a></li>
      <li><a href="#3-testing-the-new-kernel">3. Testing the new Kernel</a></li>
      <li><a href="#4-docker-version">4. Docker version</a></li>
    </ul>
  </li>
</ul>
            </nav>
          </aside>
        
        <p>How to get started with a BeagleBone Green (BBG)
including installation, internet, GPIO, device tree, Si5351 interface via i2c
and cross compiling the kernel.</p>

<h1 id="1-getting-started">1. Getting Started</h1>
<p>Instructions for getting started with the BBG are available at at 
at <a href="https://beagleboard.org/getting-started">https://beagleboard.org/getting-started</a>. This involves downloading
the Debian Linux image and writing it to a microSD card (make sure you
use the Debian image for the BBG). My version was:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Buster IoT (without graphical desktop) for BeagleBone and PocketBeagle via microSD card
AM3358 Debian 10.3 2020-04-06 4GB SD IoT image for PocketBeagle, BeagleBone, BeagleBone Black, BeagleBone Black Wireless, BeagleBone Black Industrial, BeagleBone Blue, SeeedStudio BeagleBone Green, SeeedStudio BeagleBone Green Wireless, SanCloud BeagleBone Enhanced, Arrow BeagleBone Black Industrial and Mentorel BeagleBone uSomIQ - more info - sha256sum: 22448ba28d0d58e25e875aac3b4e91eaef82e2d11c9d2c43d948ed60708f7434
</code></pre></div></div>

<p>The driver for networking via USB didn’t work with the latest version
of MacOS (Big Sur 11.2.1) but the BBG was able to use DNS over Ethernet
to connect to my network (this won’t work in the lab if there is more
than one BBG plugged into the network).  One can then run <code class="language-plaintext highlighter-rouge">ssh</code> to access (use “temppwd” as the
password for user “debian”)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span>ssh <span class="nt">-Y</span> debian@beaglebone.local
Debian GNU/Linux 10

BeagleBoard.org Debian Buster IoT TIDL Image 2020-04-06

Support: http://elinux.org/Beagleboard:BeagleBoneBlack_Debian

default username:password is <span class="o">[</span>debian:temppwd]

debian@beaglebone.local<span class="s1">'s password: 

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Feb 22 22:27:56 2021 from 192.168.0.32
debian@beaglebone:~$
</span></code></pre></div></div>

<h1 id="2-internet-connection">2. Internet Connection</h1>
<p>Drivers to support Internet via USB on the BeagleBone (see <a href="https://beagleboard.org/getting-started">Getting
Started</a>) cannot be installed
on MacOS e.g. Big Sur 11.2.1. Fortunately, the BBG uses standard Linux
networking so this is easy to solve.  In the examples that
follow, the host Mac machine has the prompt “phwl@PHWL-MBP ~ %” and
the BBG prompt is “debian@beaglebone:~$”. The same instructions should 
work for other Beaglebone Boards like the Pocket Beagle or BeagleBone
Black.</p>

<h2 id="1-connecting-via-ethernet">1. Connecting via Ethernet</h2>
<h3 id="11a-on-macos">1.1a. On MacOS</h3>

<p>Connect your Mac to the BBG using the microUSB. Connect your BBG Ethernet port to a network switch via an Ethernet cable.</p>

<p>Use <code class="language-plaintext highlighter-rouge">screen</code> to login to the BBG from your Mac via
the USB connection (use the one attached to the microUSB connector).</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phwl@PHWL-MBP ~ % screen /dev/cu.usbmodemBBG2200804786
</code></pre></div></div>

<h3 id="11b-on-windows">1.1b. On Windows</h3>
<p>Connect your PC to the BBG using the microUSB. Connect your BBG Ethernet port to a network switch via an Ethernet cable.</p>

<p>Right click the Windows menu and select “Device Manager”. After the BBG has registered the new USB device, Under “Ports (COM &amp; LPT)” you should see “USB Serial Device (COMx)” where x is a number. In my case it was COM3.</p>

<p>Download, install and run <a href="https://www.putty.org/">Putty</a>. To login to the BBG from your PC via
the USB connection (use the one attached to the microUSB connector) you select “Serial” as the Connection Type and use your com port (e.g. COM3) as the “Serial line” and click Open.</p>

<h2 id="2-connecting-via-wifi">2. Connecting via Wifi</h2>
<p>You can also connect the BBG to a Mac and then share its wifi with the BBG.</p>
<h3 id="21-macos">2.1. MacOS</h3>
<p>Connect your Mac to the BBG using the microUSB. Connect your BBG Ethernet port to the Mac’s Ethernet using an Ethernet cable (you will need an Ethernet adaptor for your Mac).</p>

<p>In “Control Panel” on your Mac, enable Internet sharing. On my machine the device is called
“Apple USB Ethernet Adaptor” so you have to turn off the “Internet Sharing” service on the left, turn on the “Apple USB Ethernet Adaptor” and then turn on “Internet Sharing” to the the window below:</p>

<figure class="">
  <a href="/assets/images/2021/03/internetsharing.png">
  <img src="/assets/images/2021/03/internetsharing.png" alt="" />
  
    <figcaption>
      

    </figcaption></a></figure>

<h3 id="22-windows-10">2.2. Windows 10</h3>
<p>Connect your PC to the BBG using the microUSB. Connect your BBG Ethernet port to the PC’s Ethernet using an Ethernet cable (you may need an Ethernet adaptor for your PC).</p>

<p>Instructions are <a href="https://blog.rottenwifi.com/how-to-share-wifi-over-ethernet-on-windows-10/">here</a>:</p>

<ol>
  <li>Right Click on the Windows start button, and you will see a menu pop up.</li>
  <li>From there, you need to click on Network Connections.</li>
  <li>Once you do so, you will be redirected to the network windows. From there, click on change adapter settings.</li>
  <li>Now, you will be redirected to the list of all the network connections available online.</li>
  <li>From there, right-click on your Wi-Fi adapter and then go to properties.</li>
  <li>Now you need to toggle the option “Allow other network users to connect.”</li>
  <li>Once done, then you need also to select the Ethernet port through which you want to allow the connection.</li>
</ol>

<p>Also, make sure that you choose the right ethernet to share the internet. If you do not make the right choice, then your connection sharing will fail. This is specifically true for those who have VPN software installed as it can create virtual ethernet ports and list them there.</p>

<h2 id="3-checking-connection">3. Checking Connection</h2>
<p>After entering Return, you should see the login prompt.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Debian GNU/Linux 10 beaglebone ttyGS0

BeagleBoard.org Debian Buster IoT TIDL Image 2020-04-06

Support: http://elinux.org/Beagleboard:BeagleBoneBlack_Debian

default username:password is <span class="o">[</span>debian:temppwd]

beaglebone login: debian
Password: 
Last login: Fri Feb 26 05:04:59 UTC 2021 on ttyGS0

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
</code></pre></div></div>

<p>Then check if you can ping sydney.edu.au:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~$ ping -c 3 sydney.edu.au
PING sydney.edu.au (129.78.5.8) 56(84) bytes of data.
64 bytes from svdns.sydney.edu.au (129.78.5.8): icmp_seq=1 ttl=242 time=12.1 ms
64 bytes from svdns.sydney.edu.au (129.78.5.8): icmp_seq=2 ttl=242 time=12.4 ms
64 bytes from svdns.sydney.edu.au (129.78.5.8): icmp_seq=3 ttl=242 time=19.8 ms

--- sydney.edu.au ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 6ms
rtt min/avg/max/mdev = 12.144/14.812/19.849/3.566 ms
</code></pre></div></div>

<p>You can exit the <code class="language-plaintext highlighter-rouge">screen</code> program with control-A and then k (if you just disconnect the USB, the /dev/cu.usbmodemBBG2200804786 device will disappear and you will need to reboot the Mac if it is needed again).</p>

<h3 id="3-to-login-to-the-bbg-via-ethernet">3. To Login to the BBG via Ethernet</h3>
<p>On the BeagleBone type:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~$ ifconfig
eth0: flags=-28605&lt;UP,BROADCAST,RUNNING,MULTICAST,DYNAMIC&gt;  mtu 1500
        inet 169.254.120.60  netmask 255.255.0.0  broadcast 169.254.255.255
        inet6 fe80::1642:fcff:fe0c:b433  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 14:42:fc:0c:b4:33  txqueuelen 1000  (Ethernet)
        RX packets 719  bytes 229866 (224.4 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 331  bytes 91879 (89.7 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
        device interrupt 45

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 3968  bytes 266448 (260.2 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 3968  bytes 266448 (260.2 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

usb0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.7.2  netmask 255.255.255.0  broadcast 192.168.7.255
        inet6 fe80::1642:fcff:fe0c:b435  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 14:42:fc:0c:b4:35  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

usb1: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
        inet 192.168.6.2  netmask 255.255.255.0  broadcast 192.168.6.255
        ether 14:42:fc:0c:b4:39  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">ifconfig</code> command shows that the <code class="language-plaintext highlighter-rouge">eth0</code> device has the IP address <code class="language-plaintext highlighter-rouge">169.254.120.60</code>. You can use this address directly, or <code class="language-plaintext highlighter-rouge">beaglebone.local</code> if that is the only device on your local network.</p>

<p>From another terminal window on your Mac (or any other machine on the same network), you should be able to log into the BBG:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phwl@PHWL-MBP ~ % ssh debian@169.254.120.60 <span class="c"># or ssh debian@beaglebone.local</span>
The authenticity of host <span class="s1">'169.254.120.60 (169.254.120.60)'</span> can<span class="s1">'t be established.
ECDSA key fingerprint is SHA256:6iPvBW868tpt8HVZLemzVVPKAI5n5C669GwfLKiws34.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>169.254.120.60<span class="s1">' (ECDSA) to the list of known hosts.
Debian GNU/Linux 10

BeagleBoard.org Debian Buster IoT TIDL Image 2020-04-06

Support: http://elinux.org/Beagleboard:BeagleBoneBlack_Debian

default username:password is [debian:temppwd]

debian@169.254.120.60'</span>s password: 

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Feb 26 05:05:45 2021
</code></pre></div></div>

<h1 id="3-gpio">3. GPIO</h1>
<p>Since Linux v4.8, the standard way of using Linux GPIO has been via 
<a href="https://git.kernel.org/pub/scm/libs/libgpiod/libgpiod.git/">libgpiod</a>.
Prior to the introduction of libgpiod, the
sysfs interface was used, but sysfs is depreciated and was removed from the mainline Linux kernel
in 2020. 
The best source of information on libgpiod
<a href="https://git.kernel.org/pub/scm/libs/libgpiod/libgpiod.git/about/">comes with the library</a> and the (<a href="http://phwl.org/assets/images/2021/02/libgpiod-ref.pdf">libgpiod manual</a>).</p>

<p>The library comes with a number of command line tools to manipulate GPIOs:</p>
<ul>
  <li>
    <p>gpiodetect - list all gpiochips present on the system, their names, labels
            and number of GPIO lines</p>
  </li>
  <li>
    <p>gpioinfo   - list all lines of specified gpiochips, their names, consumers,
            direction, active state and additional flags</p>
  </li>
  <li>
    <p>gpioget    - read values of specified GPIO lines</p>
  </li>
  <li>
    <p>gpioset    - set values of specified GPIO lines, potentially keep the lines
            exported and wait until timeout, user input or signal</p>
  </li>
  <li>
    <p>gpiofind   - find the gpiochip name and line offset given the line name</p>
  </li>
  <li>
    <p>gpiomon    - wait for events on GPIO lines, specify which events to watch,
            how many events to process before exiting or if the events
            should be reported to the console.</p>
  </li>
</ul>

<p>Here are some usage examples from the Linux documentation (some like <code class="language-plaintext highlighter-rouge">gpiomon</code> won’t work on the BBG without an input source):</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c"># Read the value of a single GPIO line.</span>
    <span class="nv">$ </span>gpioget gpiochip1 23
    0

    <span class="c"># Read two values at the same time. Set the active state of the lines</span>
    <span class="c"># to low.</span>
    <span class="nv">$ </span>gpioget <span class="nt">--active-low</span> gpiochip1 23 24
    1 1

    <span class="c"># Set values of two lines, then daemonize and wait for a signal (SIGINT or</span>
    <span class="c"># SIGTERM) before releasing them.</span>
    <span class="nv">$ </span>gpioset <span class="nt">--mode</span><span class="o">=</span>signal <span class="nt">--background</span> gpiochip1 <span class="nv">23</span><span class="o">=</span>1 <span class="nv">24</span><span class="o">=</span>0

    <span class="c"># Set the value of a single line, then exit immediately. This is useful</span>
    <span class="c"># for floating pins.</span>
    <span class="nv">$ </span>gpioset gpiochip1 <span class="nv">23</span><span class="o">=</span>1

    <span class="c"># Find a GPIO line by name.</span>
    <span class="nv">$ </span>gpiofind <span class="s2">"USR-LED-2"</span> gpiochip1 23

    <span class="c"># Toggle a GPIO by name, then wait for the user to press ENTER.</span>
    <span class="nv">$ </span>gpioset <span class="nt">--mode</span><span class="o">=</span><span class="nb">wait</span> <span class="sb">`</span>gpiofind <span class="s2">"USR-LED-2"</span><span class="sb">`</span><span class="o">=</span>1

    <span class="c"># Wait for three rising edge events on a single GPIO line, then exit.</span>
    <span class="nv">$ </span>gpiomon <span class="nt">--num-events</span><span class="o">=</span>3 <span class="nt">--rising-edge</span> gpiochip2 3
    event:  RISING EDGE offset: 3 timestamp: <span class="o">[</span>    1151.814356387]
    event:  RISING EDGE offset: 3 timestamp: <span class="o">[</span>    1151.815449803]
    event:  RISING EDGE offset: 3 timestamp: <span class="o">[</span>    1152.091556803]

    <span class="c"># Wait for a single falling edge event. Specify a custom output format.</span>
    <span class="nv">$ </span>gpiomon <span class="nt">--format</span><span class="o">=</span><span class="s2">"%e %o %s %n"</span> <span class="nt">--falling-edge</span> gpiochip1 4 0 4 1156 615459801

    <span class="c"># Pause execution until a single event of any type occurs. Don't print</span>
    <span class="c"># anything. Find the line by name.</span>
    <span class="nv">$ </span>gpiomon <span class="nt">--num-events</span><span class="o">=</span>1 <span class="nt">--silent</span> <span class="sb">`</span>gpiofind <span class="s2">"USR-IN"</span><span class="sb">`</span>

    <span class="c"># Monitor multiple lines, exit after the first event.</span>
    <span class="nv">$ </span>gpiomon <span class="nt">--silent</span> <span class="nt">--num-events</span><span class="o">=</span>1 gpiochip0 2 3 5
</code></pre></div></div>

<h2 id="1-laboratory-experiment">1. Laboratory Experiment</h2>
<h3 id="part-1---setup-10">Part 1 - Setup (10%)</h3>
<p>To use GPIO on the BBG, one must
first login to the beagleboard:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phwl@PHWL-MBP lab1-gpio % ssh debian@beaglebone.local
Debian GNU/Linux 10

BeagleBoard.org Debian Buster IoT Image 2020-04-06

Support: http://elinux.org/Beagleboard:BeagleBoneBlack_Debian

default username:password is <span class="o">[</span>debian:temppwd]

debian@10.65.196.185<span class="s1">'s password: 

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Mar  3 04:58:05 2021 from 10.17.29.225
</span></code></pre></div></div>

<p>Then update the Debian package manager:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>debian: 
Hit:1 http://deb.debian.org/debian buster InRelease
Get:2 http://deb.debian.org/debian buster-updates InRelease <span class="o">[</span>51.9 kB]
Get:3 http://repos.rcn-ee.com/debian buster InRelease <span class="o">[</span>3,078 B]
Get:4 http://deb.debian.org/debian-security buster/updates InRelease <span class="o">[</span>65.4 kB]
Get:5 http://deb.debian.org/debian-security buster/updates/main armhf Packages <span class="o">[</span>262 kB]
Get:6 http://repos.rcn-ee.com/debian buster/main armhf Packages <span class="o">[</span>1,740 kB]     
Fetched 2,122 kB <span class="k">in </span>50s <span class="o">(</span>42.6 kB/s<span class="o">)</span>                                            
Reading package lists... Done
Building dependency tree       
Reading state information... Done
110 packages can be upgraded. Run <span class="s1">'apt list --upgradable'</span> to see them.
</code></pre></div></div>

<p>Now install the libgpiod library and git:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>libgpiod-dev git
Reading package lists... Done
Building dependency tree       
Reading state information... Done
libgpiod-dev is already the newest version <span class="o">(</span>1.4.1-2rcnee3~buster+20190906<span class="o">)</span><span class="nb">.</span>
Suggested packages:
  gettext-base git-daemon-run | git-daemon-sysvinit git-doc git-el git-email
  git-gui gitk gitweb git-cvs git-mediawiki git-svn
The following packages will be upgraded:
  git
1 upgraded, 0 newly installed, 0 to remove and 109 not upgraded.
Need to get 4,542 kB of archives.
After this operation, 50.2 kB of additional disk space will be used.
Do you want to <span class="k">continue</span>? <span class="o">[</span>Y/n] 
Get:1 http://deb.debian.org/debian buster/main armhf git armhf 1:2.20.1-2+deb10u3 <span class="o">[</span>4,542 kB]
Fetched 4,542 kB <span class="k">in </span>3s <span class="o">(</span>1,396 kB/s<span class="o">)</span>
<span class="o">(</span>Reading database ... 72582 files and directories currently installed.<span class="o">)</span>
Preparing to unpack .../git_1%3a2.20.1-2+deb10u3_armhf.deb ...
Unpacking git <span class="o">(</span>1:2.20.1-2+deb10u3<span class="o">)</span> over <span class="o">(</span>1:2.20.1-2+deb10u1<span class="o">)</span> ...
Setting up git <span class="o">(</span>1:2.20.1-2+deb10u3<span class="o">)</span> ...
</code></pre></div></div>

<p>Clone the starting files for this lab</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span>git clone https://github.com/phwl/elec3607-labquestions.git
Cloning into <span class="s1">'elec3607-labquestions'</span>...
remote: Enumerating objects: 63, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>63/63<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>39/39<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 63 <span class="o">(</span>delta 21<span class="o">)</span>, reused 52 <span class="o">(</span>delta 13<span class="o">)</span>, pack-reused 0
Unpacking objects: 100% <span class="o">(</span>63/63<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
</code></pre></div></div>

<p>and install a Device Tree overlay to set the pinctl mode of the pins we will be
using to Mode 7 
(we will cover Device Trees later in this course):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span><span class="nb">cd </span>elec3607-labquestions/labs/lab1-gpio/
debian@beaglebone:~/elec3607-labquestions/labs/lab1-gpio<span class="nv">$ </span>make <span class="nb">install
sudo cp </span>PHWL-GPIO-00A0.dtbo /lib/firmware
<span class="nb">sudo cp </span>uEnv.txt /boot
</code></pre></div></div>

<p>You will need to reboot the system for the Device Tree changes to take effect.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~/elec3607-labquestions/labs/lab1-gpio<span class="nv">$ </span><span class="nb">sudo </span>shutdown <span class="nt">-r</span> now
</code></pre></div></div>

<p>You can check everything is working by detecting the GPIO chips
and printing their labels and state.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~$ gpiodetect
gpiochip0 [gpio] (32 lines)
gpiochip1 [gpio] (32 lines)
gpiochip2 [gpio] (32 lines)
gpiochip3 [gpio] (32 lines)
debian@beaglebone:~$ gpioinfo
gpiochip0 - 32 lines:
	line   0:  "MDIO_DATA"       unused   input  active-high 
	line   1:   "MDIO_CLK"       unused   input  active-high 
...
</code></pre></div></div>

<p>Now turn on the D5 LED for 10 seconds using</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span>gpioset <span class="nt">-m</span> <span class="nb">time</span> <span class="nt">-s</span> 10 gpiochip1 <span class="nv">24</span><span class="o">=</span>1
</code></pre></div></div>
<p>and turn it off for 10 seconds</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~$ gpioset -m time -s 10 gpiochip1 24=0
</code></pre></div></div>
<p>Note that after <code class="language-plaintext highlighter-rouge">gpioset</code> exits, the data of the output is undefined.</p>

<h3 id="part-2---s2-button-input-30">Part 2 - S2 Button Input (30%)</h3>
<p>Download, compile and execute the <code class="language-plaintext highlighter-rouge">blink</code> program which flashes the D5 LED as follows</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~/elec3607-labquestions/labs/lab1-gpio<span class="nv">$ </span><span class="nb">ls
</span>blink.c  Makefile  PHWL-GPIO-00A0.dtbo  PHWL-GPIO.dts  ssd.c
debian@beaglebone:~/elec3607-labquestions/labs/lab1-gpio<span class="nv">$ </span>make
cc    <span class="nt">-c</span> <span class="nt">-o</span> ssd.o ssd.c
gcc <span class="nt">-o</span> ssd ssd.c <span class="nt">-lgpiod</span>
cc    <span class="nt">-c</span> <span class="nt">-o</span> blink.o blink.c
gcc <span class="nt">-o</span> blink blink.c <span class="nt">-lgpiod</span>
dtc <span class="nt">-O</span> dtb <span class="nt">-o</span> PHWL-GPIO-00A0.dtbo <span class="nt">-b</span> 0 -@ PHWL-GPIO.dts
debian@beaglebone:~/elec3607-labquestions/labs/lab1-gpio<span class="nv">$ </span>./blink
</code></pre></div></div>

<p>Here is a listing of <code class="language-plaintext highlighter-rouge">blink.c</code></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="cm">/*
 * **    blink.c -    blink with 1s delay 
 * */</span>

<span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;gpiod.h&gt;
</span>
<span class="cp">#define GPIOCHIP        1
#define GPIOLINE        24
</span>
<span class="kt">int</span> 
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">gpiod_chip</span> <span class="o">*</span><span class="n">output_chip</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">gpiod_line</span> <span class="o">*</span><span class="n">output_line</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">line_value</span><span class="p">;</span>

        <span class="cm">/* open chip and get line */</span>
        <span class="n">output_chip</span> <span class="o">=</span> <span class="n">gpiod_chip_open_by_number</span><span class="p">(</span><span class="n">GPIOCHIP</span><span class="p">);</span>
        <span class="n">output_line</span> <span class="o">=</span> <span class="n">gpiod_chip_get_line</span><span class="p">(</span><span class="n">output_chip</span><span class="p">,</span> <span class="n">GPIOLINE</span><span class="p">);</span>

        <span class="cm">/* config as output and set a description */</span>
        <span class="n">gpiod_line_request_output</span><span class="p">(</span><span class="n">output_line</span><span class="p">,</span> <span class="s">"blink"</span><span class="p">,</span> <span class="n">GPIOD_LINE_ACTIVE_STATE_HIGH</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(;;)</span>
        <span class="p">{</span>
                <span class="n">line_value</span> <span class="o">=</span> <span class="o">!</span><span class="n">line_value</span><span class="p">;</span>
                <span class="n">gpiod_line_set_value</span><span class="p">(</span><span class="n">output_line</span><span class="p">,</span> <span class="n">line_value</span><span class="p">);</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Referring to the <a href="http://phwl.org/assets/images/2021/02/libgpiod-ref.pdf">libgpiod manual</a>, we obtain a descriptor for the chip specified by <code class="language-plaintext highlighter-rouge">GPIOCHIP</code> in line 20. Using that descriptor we obtain one for the line in line 21. 
In line 24, we configure the pin as an output, and give it the name “blink” (this is called a consumer in libgpiod). Line 28 toggles <code class="language-plaintext highlighter-rouge">line_value</code> between a true and false value, which is written to the line in line 29. We then sleep for 1 second before returning to the top of the infinite loop. You can press control-C to exit the program.</p>

<p>Modify the program so that, in addition to blinking the LED, it will
print the status of the S2 button once a second as below.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span>./blink 
<span class="nv">S2</span><span class="o">=</span>1
...
<span class="nv">S2</span><span class="o">=</span>0
</code></pre></div></div>

<h3 id="part-3---seven-segment-display-60">Part 3 - Seven Segment Display (60%)</h3>

<figure class="">
  <a href="/assets/images/2021/02/ledres.jpg">
  <img src="/assets/images/2021/02/ledres.jpg" alt="" />
  
    <figcaption>
      

    </figcaption></a></figure>

<p>Here is a listing of <code class="language-plaintext highlighter-rouge">ssd.c</code>, a program to be completed in this exercise.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="code"><pre><span class="cm">/*
 * ssd.c -    count up and down on the SSD
 * 
*/</span>

<span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;gpiod.h&gt;
</span>
<span class="cm">/* the SSD is entirely on this chip */</span>
<span class="cp">#define OUT_GPIOCHIP	0
</span>
<span class="cm">/* the S2 button on the BBG */</span>
<span class="cp">#define	IN_GPIOCHIP		2
#define	IN_GPIOLINE		8
</span>
<span class="cp">#define	NELTS(x)	(sizeof(x) / sizeof(x[0]))	// calculate number of elements in x
#define	SEGMENTS	NELTS(gpiossd)
</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">gpiossd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">31</span> <span class="p">};</span>

<span class="cm">/* FILL THIS IN */</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">ssd</span><span class="p">[][</span><span class="n">SEGMENTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 0 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 1 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 2 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 3 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 4 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 5 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 6 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 7 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>	<span class="cm">/* 8 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">};</span>	<span class="cm">/* 9 */</span>

<span class="kt">int</span> 
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">struct</span>	<span class="n">gpiod_chip</span> <span class="o">*</span><span class="n">output_chip</span><span class="p">;</span>
    <span class="k">struct</span>	<span class="n">gpiod_line</span> <span class="o">*</span><span class="n">output_line</span><span class="p">[</span><span class="n">SEGMENTS</span><span class="p">];</span>
	<span class="k">struct</span>	<span class="n">gpiod_chip</span> <span class="o">*</span><span class="n">input_chip</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">gpiod_line</span> <span class="o">*</span><span class="n">input_line</span><span class="p">;</span>
    <span class="kt">int</span>		<span class="n">line_value</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* open input */</span>
	<span class="n">input_chip</span> <span class="o">=</span> <span class="n">gpiod_chip_open_by_number</span><span class="p">(</span><span class="n">IN_GPIOCHIP</span><span class="p">);</span>
	<span class="n">input_line</span> <span class="o">=</span> <span class="n">gpiod_chip_get_line</span><span class="p">(</span><span class="n">input_chip</span><span class="p">,</span> <span class="n">IN_GPIOLINE</span><span class="p">);</span>
	<span class="n">gpiod_line_request_input</span><span class="p">(</span><span class="n">input_line</span><span class="p">,</span> <span class="s">"ssd"</span><span class="p">);</span>

    <span class="cm">/* open /dev/gpiochip0 */</span>
    <span class="n">output_chip</span> <span class="o">=</span> <span class="n">gpiod_chip_open_by_number</span><span class="p">(</span><span class="n">OUT_GPIOCHIP</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEGMENTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">output_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpiod_chip_get_line</span><span class="p">(</span><span class="n">output_chip</span><span class="p">,</span> <span class="n">gpiossd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="cm">/* config as output and set a description */</span>
		<span class="n">gpiod_line_request_output</span><span class="p">(</span><span class="n">output_line</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">"ssd"</span><span class="p">,</span> <span class="n">GPIOD_LINE_ACTIVE_STATE_HIGH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* the digit to display */</span>
	<span class="k">for</span> <span class="p">(;;)</span> 
	<span class="p">{</span>
		<span class="cm">/* display all segments */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">SEGMENTS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
            <span class="cm">/* FILL THIS IN */</span>
		<span class="p">}</span>
        	<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* update count */</span>

        <span class="cm">/* FILL THIS IN */</span>
	<span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Refer to the <a href="http://exploringbeaglebone.com/wp-content/uploads/2019/01/533160-c06f009.png">Beaglebone P9 connector table</a> for the mapping of pins to the gpiochip0 lines.</p>

<p>The data sheet for a seven segment display (SSD) is available <a href="https://au.element14.com/broadcom-limited/5082-7613/led-display-0-3-he-red/dp/1175576">here</a>.</p>
<ul>
  <li>Calculate the resistor value so that the current to drive the LED (voltage is 3.3V-Vf where Vf=the diode forward voltage drop) doesn’t exceed 4mA.</li>
  <li>After studying <code class="language-plaintext highlighter-rouge">ssd.c</code>, connect up the SSD to the BBG via a breadboard.</li>
  <li>Complete the “FILL THIS IN” parts of <code class="language-plaintext highlighter-rouge">ssd.c</code> so the value changes in value 0 to 9 every second then goes back to 0. When S2 is pressed it should count backwards.</li>
</ul>

<p>Note that for the program to work, you will need to use the same GPIO lines as the program.</p>

<h1 id="4-device-tree">4. Device Tree</h1>
<p>This section describes configuration of the BeagleBone Green GPIO pinmux
settings via the Linux Device Tree.</p>

<h2 id="1-setting-pinmux-values-via-the-device-tree">1. Setting pinmux values via the Device Tree</h2>
<p>The pins of the BBG P9 header have different operations depending on
the pinmum mode chosen. Looking at the <a href="http://exploringbeaglebone.com/wp-content/uploads/resources/BBBP9Header.pdf">P9 header</a>, Mode 7 connects the GPIO line to the pin of the AM335X chip. To configure this, we need to set the mode via the Linux Device Tree (DT). How the DT works will be covered as a later topic, but this (admittedly complicated) configuration below will set</p>

<p>First make the following dts file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>PHWL-GPIO.dts 
/<span class="k">*</span>  
<span class="k">*</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2012 Texas Instruments Incorporated - http://www.ti.com/
<span class="k">*</span>
<span class="k">*</span> This program is free software<span class="p">;</span> you can redistribute it and/or modify
<span class="k">*</span> it under the terms of the GNU General Purpose License Version 2 as
<span class="k">*</span> published by the Free Software Foundation
<span class="k">*</span>
<span class="k">*</span> Original from: github.com/jadonk/validation-scripts/blob/master/test-capemgr/ 
<span class="k">*</span>
<span class="k">*</span> Modified by Derek Molloy <span class="k">for </span>the example on www.derekmolloy.ie
<span class="k">*</span> that maps GPIO pins <span class="k">for </span>the example
<span class="k">*</span>
<span class="k">*</span> Modified by Philip Leong <span class="k">for </span>SSD exercise
<span class="k">*</span>
<span class="k">*</span>/

/dts-v1/<span class="p">;</span>
/plugin/<span class="p">;</span>

/<span class="o">{</span>
       compatible <span class="o">=</span> <span class="s2">"ti,beaglebone"</span>, <span class="s2">"ti,beaglebone-black"</span><span class="p">;</span>
       part-number <span class="o">=</span> <span class="s2">"PHWL-GPIO"</span><span class="p">;</span>
       version <span class="o">=</span> <span class="s2">"00A0"</span><span class="p">;</span>

       fragment@0 <span class="o">{</span>
             target <span class="o">=</span> &lt;&amp;am33xx_pinmux&gt;<span class="p">;</span>
            
             __overlay__ <span class="o">{</span>
                  pinctrl_test: PHWL_GPIO_Pins <span class="o">{</span>
			pinctrl-single,pins <span class="o">=</span> &lt;

                   0x180 0x07  /<span class="k">*</span> P9_26 OUT <span class="k">*</span>/
                   0x184 0x07  /<span class="k">*</span> P9_24 OUT <span class="k">*</span>/
                   0x150 0x07  /<span class="k">*</span> P9_22 OUT <span class="k">*</span>/
                   0x178 0x07  /<span class="k">*</span> P9_20 OUT <span class="k">*</span>/
                   0x17c 0x07  /<span class="k">*</span> P9_19 OUT <span class="k">*</span>/
                   0x158 0x07  /<span class="k">*</span> P9_18 OUT <span class="k">*</span>/
                   0x15c 0x07  /<span class="k">*</span> P9_17 OUT <span class="k">*</span>/
                   0x074 0x07  /<span class="k">*</span> P9_13 OUT <span class="k">*</span>/
                   0x0a8 0x37  /<span class="k">*</span> P8_43 PULLUP IN <span class="k">*</span>/
                       
                   /<span class="k">*</span> OUTPUT  GPIO<span class="o">(</span>mode7<span class="o">)</span> 0x07 pulldown, 0x17 pullup, 0x?f no pullup/down <span class="k">*</span>/
                   /<span class="k">*</span> INPUT   GPIO<span class="o">(</span>mode7<span class="o">)</span> 0x27 pulldown, 0x37 pullup, 0x?f no pullup/down <span class="k">*</span>/

			<span class="o">&gt;</span><span class="p">;</span>
		  <span class="o">}</span><span class="p">;</span>
             <span class="o">}</span><span class="p">;</span>
       <span class="o">}</span><span class="p">;</span>

       fragment@1 <span class="o">{</span>
		target <span class="o">=</span> &lt;&amp;ocp&gt;<span class="p">;</span>
		__overlay__ <span class="o">{</span>
			test_helper: helper <span class="o">{</span>
				compatible <span class="o">=</span> <span class="s2">"bone-pinmux-helper"</span><span class="p">;</span>
				pinctrl-names <span class="o">=</span> <span class="s2">"default"</span><span class="p">;</span>
				pinctrl-0 <span class="o">=</span> &lt;&amp;pinctrl_test&gt;<span class="p">;</span>
				status <span class="o">=</span> <span class="s2">"okay"</span><span class="p">;</span>
			<span class="o">}</span><span class="p">;</span>
		<span class="o">}</span><span class="p">;</span>
	<span class="o">}</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
</code></pre></div></div>

<p>to build</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dtc <span class="nt">-O</span> dtb <span class="nt">-o</span> PHWL-GPIO-00A0.dtbo <span class="nt">-b</span> 0 -@ PHWL-GPIO.dts
<span class="nv">$ </span><span class="nb">sudo cp </span>PHWL-GPIO-00A0.dtbo /lib/firmware/
</code></pre></div></div>
<p>Modify <code class="language-plaintext highlighter-rouge">/boot/uEnv.txt</code> to be:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /boot/uEnv.txt 
<span class="c">#Docs: http://elinux.org/Beagleboard:U-boot_partitioning_layout_2.0</span>

<span class="nv">uname_r</span><span class="o">=</span>4.14.108-ti-r131
<span class="c">#uuid=</span>
<span class="c">#dtb=</span>
<span class="nv">cmdline</span><span class="o">=</span><span class="nv">coherent_pool</span><span class="o">=</span>1M net.ifnames<span class="o">=</span>0 rng_core.default_quality<span class="o">=</span>100 quiet
<span class="nv">enable_uboot_overlays</span><span class="o">=</span>1
<span class="nv">uboot_overlay_addr0</span><span class="o">=</span>/lib/firmware/PHWL-GPIO-00A0.dtbo

<span class="c">#In the event of edid real failures, uncomment this next line:</span>
<span class="c">#cmdline=coherent_pool=1M net.ifnames=0 rng_core.default_quality=100 quiet video=HDMI-A-1:1024x768@60e</span>

<span class="c">##enable x15: eMMC Flasher:</span>
<span class="c">##make sure, these tools are installed: dosfstools rsync</span>
<span class="c">#cmdline=init=/opt/scripts/tools/eMMC/init-eMMC-flasher-v3-no-eeprom.sh</span>
</code></pre></div></div>
<p>reboot (<code class="language-plaintext highlighter-rouge">shutdown -r now</code>) and the modes should have changed to 007</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep 007 /sys/kernel/debug/pinctrl/44e10800.pinmux/pins
pin 21 (PIN21) 44e10854 00000007 pinctrl-single 
pin 23 (PIN23) 44e1085c 00000007 pinctrl-single 
pin 29 (PIN29) 44e10874 00000007 pinctrl-single 
pin 84 (PIN84) 44e10950 00000007 pinctrl-single 
pin 85 (PIN85) 44e10954 00000007 pinctrl-single 
pin 86 (PIN86) 44e10958 00000007 pinctrl-single 
pin 87 (PIN87) 44e1095c 00000007 pinctrl-single 
pin 94 (PIN94) 44e10978 00000007 pinctrl-single 
pin 95 (PIN95) 44e1097c 00000007 pinctrl-single 
</code></pre></div></div>

<h1 id="5-si5351-interface-via-i2c">5. Si5351 interface via i2c</h1>
<p>This section describes how to connect the BeagleBone to a Silicon Labs
<a href="https://www.silabs.com/documents/public/data-sheets/Si5351-B.pdf">Si5351</a>
i2c clock generator.</p>

<h2 id="1-i2c-interface-to-si5351">1. I2C Interface to Si5351</h2>
<p>The i2c interface is simple, ensure that the SDA and SCL lines of
the Si5351 are connected to an appropriate port on the Beaglebone.
In the example below, I used /dev/i2c-2.</p>

<p>Then make sure all the software required is installed on the BBG.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>libi2c-dev
</code></pre></div></div>

<p>The commands below show all the i2c devices and that the Si5351 
at address 0x60 is responding to the probe on I2C2 (i2c chip 2):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~$ i2cdetect -l
i2c-1	i2c       	OMAP I2C adapter                	I2C adapter
i2c-2	i2c       	OMAP I2C adapter                	I2C adapter
i2c-0	i2c       	OMAP I2C adapter                	I2C adapter
debian@beaglebone:~$ i2cdetect -y -r 2
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: 60 -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --                         
</code></pre></div></div>

<p>Here is part of the i2c transaction for <code class="language-plaintext highlighter-rouge">i2cdetect -y -r 2 0x60 0x60</code>.</p>

<figure class="">
  <a href="/assets/images/2021/03/si5351-i2c.jpg">
  <img src="/assets/images/2021/03/si5351-i2c.jpg" alt="" />
  
    <figcaption>
      

    </figcaption></a></figure>

<h2 id="2-linux-userspace-driver">2. Linux userspace driver</h2>

<p>There are several ways that this interface can be made. We are going
to create a userspace driver with the Linux  i2c-dev module
(which is the most straightforward approach). 
The following program, derived from the Linux Kernel <a href="https://www.kernel.org/doc/html/latest/i2c/dev-interface.html">userspace driver documentation</a> reads and prints register 0 of device /dev/i2c-2, address 0x60, i.e. register 0 of the Si5351. Note that the reason we need to specify address 0x60 is that there could be multiple devices connected to a single i2c chip.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;linux/i2c-dev.h&gt;
#include &lt;i2c/smbus.h&gt;
</span>
<span class="cp">#define	I2C_FNAME	"/dev/i2c-2"
#define	SI5351_ADDR	0x60
</span>
<span class="kt">int</span>	<span class="n">i2c_file</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">i2c_init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">i2c_file</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">I2C_FNAME</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_file</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i2c_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">i2c_file</span><span class="p">,</span> <span class="n">I2C_SLAVE</span><span class="p">,</span> <span class="n">SI5351_ADDR</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* Using SMBus commands */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">i2c_file</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> 
		<span class="n">printf</span><span class="p">(</span><span class="s">"r dev(0x%x) reg(0x%x)=0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SI5351_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">i2c_init</span><span class="p">();</span>
	<span class="n">i2c_read</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>It can be compiled and executed as follows:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span>gcc <span class="nt">-o</span> si5351 si5351.c <span class="nt">-li2c</span>
debian@beaglebone:~<span class="nv">$ </span>./si5351 
r dev<span class="o">(</span>0x60<span class="o">)</span> reg<span class="o">(</span>0x0<span class="o">)=</span>0x11
</code></pre></div></div>

<h2 id="3-programming-the-clock-generator">3. Programming the Clock Generator</h2>
<p>The <a href="https://www.silabs.com/documents/public/data-sheets/Si5351-B.pdf">data sheet</a> for the Si5351 refers to the <a href="https://www.silabs.com/developers/clockbuilder-pro-software">Clock builder</a> software. This is only available for Windows 
but in embedded systems it is a fact of life that if you use operating
system X, there will be a piece of software that is only supported on operating system Y that you need. Here
is a header file that I generated for CLK0 and CLK1 outputs of 28.1544 MHz.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
</pre></td><td class="code"><pre><span class="cm">/*
 * Si5351A Rev B Configuration Register Export Header File
 *
 * This file represents a series of Silicon Labs Si5351A Rev B 
 * register writes that can be performed to load a single configuration 
 * on a device. It was created by a Silicon Labs ClockBuilder Pro
 * export tool.
 *
 * Part:		                                       Si5351A Rev B
 * Design ID:                                          
 * Includes Pre/Post Download Control Register Writes: Yes
 * Created By:                                         ClockBuilder Pro v3.1 [2021-01-18]
 * Timestamp:                                          2021-03-12 15:00:15 GMT-08:00
 *
 * A complete design report corresponding to this export is included at the end 
 * of this header file.
 *
 */</span>

<span class="cp">#ifndef SI5351A_REVB_REG_CONFIG_HEADER
#define SI5351A_REVB_REG_CONFIG_HEADER
</span>
<span class="cp">#define SI5351A_REVB_REG_CONFIG_NUM_REGS				52
</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">;</span> <span class="cm">/* 16-bit register address */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">;</span> <span class="cm">/* 8-bit register data */</span>

<span class="p">}</span> <span class="n">si5351a_revb_register_t</span><span class="p">;</span>

<span class="n">si5351a_revb_register_t</span> <span class="k">const</span> <span class="n">si5351a_revb_registers</span><span class="p">[</span><span class="n">SI5351A_REVB_REG_CONFIG_NUM_REGS</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x53</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000F</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0F</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x8C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x8C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x8C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0x8C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x8C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0017</span><span class="p">,</span> <span class="mh">0x8C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001A</span><span class="p">,</span> <span class="mh">0xAF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001B</span><span class="p">,</span> <span class="mh">0xC8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001C</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001D</span><span class="p">,</span> <span class="mh">0x0E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001E</span><span class="p">,</span> <span class="mh">0x8D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001F</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x85</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="mh">0x58</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x002A</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x002B</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x002C</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x002D</span><span class="p">,</span> <span class="mh">0x0D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="mh">0xE0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0033</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0034</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0035</span><span class="p">,</span> <span class="mh">0x0D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0xE0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0037</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0038</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0039</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x005B</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0095</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0096</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0097</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0098</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0099</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x009A</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x009B</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00A2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00A3</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00A4</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00A5</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00A6</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00B7</span><span class="p">,</span> <span class="mh">0x92</span> <span class="p">},</span>

<span class="p">};</span>

<span class="cm">/*
 * Design Report
 *
 * Overview
 * ========
 * Part:               Si5351A
 * Created By:         ClockBuilder Pro v3.1 [2021-01-18]
 * Timestamp:          2021-03-12 15:00:15 GMT-08:00
 * 
 * Design Notes
 * ============
 * Si5351A 10-pin MSOP
 * 
 * Design Rule Check
 * =================
 * Errors:
 * - No errors
 * 
 * Warnings:
 * - No warnings
 * 
 * Design
 * ======
 * Inputs:
 *     IN0: 27 MHz
 * 
 * Outputs:
 *    OUT0: 28.1544 MHz
 *          Enabled LVCMOS 8 mA
 *          Offset 0.000 s 
 *    OUT1: 28.1544 MHz
 *          Enabled LVCMOS 8 mA
 *          Offset 0.000 s 
 *    OUT2: Unused
 * 
 * Frequency Plan
 * ==============
 * PLL_A:
 *    Enabled Features = None
 *    Fvco             = 893.9022 MHz
 *    M                = 33.1074888888888888... [ 33 + 4837/45000 ]
 *    Input0:
 *       Source           = Crystal
 *       Source Frequency = 27 MHz
 *       Fpfd             = 27 MHz
 *       Load Capacitance = Load_08pF
 *    Output0:
 *       Features       = None
 *       Disabled State = StopLow
 *       R              = 1  (2^0)
 *       Fout           = 28.1544 MHz
 *       N              = 31.75
 *    Output1:
 *       Features       = None
 *       Disabled State = StopLow
 *       R              = 1  (2^0)
 *       Fout           = 28.1544 MHz
 *       N              = 31.75
 * 
 * Settings
 * ========
 * 
 * Location      Setting Name    Decimal Value      Hex Value        
 * ------------  --------------  -----------------  -----------------
 * 0x0002[3]     XO_LOS_MASK     0                  0x0              
 * 0x0002[4]     CLK_LOS_MASK    1                  0x1              
 * 0x0002[5]     LOL_A_MASK      0                  0x0              
 * 0x0002[6]     LOL_B_MASK      1                  0x1              
 * 0x0002[7]     SYS_INIT_MASK   0                  0x0              
 * 0x0003[7:0]   CLK_OEB         0                  0x00             
 * 0x0004[4]     DIS_RESET_LOLA  0                  0x0              
 * 0x0004[5]     DIS_RESET_LOLB  1                  0x1              
 * 0x0007[7:4]   I2C_ADDR_CTRL   0                  0x0              
 * 0x000F[2]     PLLA_SRC        0                  0x0              
 * 0x000F[3]     PLLB_SRC        0                  0x0              
 * 0x000F[4]     PLLA_INSELB     0                  0x0              
 * 0x000F[5]     PLLB_INSELB     0                  0x0              
 * 0x000F[7:6]   CLKIN_DIV       0                  0x0              
 * 0x0010[1:0]   CLK0_IDRV       3                  0x3              
 * 0x0010[3:2]   CLK0_SRC        3                  0x3              
 * 0x0010[4]     CLK0_INV        0                  0x0              
 * 0x0010[5]     MS0_SRC         0                  0x0              
 * 0x0010[6]     MS0_INT         0                  0x0              
 * 0x0010[7]     CLK0_PDN        0                  0x0              
 * 0x0011[1:0]   CLK1_IDRV       3                  0x3              
 * 0x0011[3:2]   CLK1_SRC        3                  0x3              
 * 0x0011[4]     CLK1_INV        0                  0x0              
 * 0x0011[5]     MS1_SRC         0                  0x0              
 * 0x0011[6]     MS1_INT         0                  0x0              
 * 0x0011[7]     CLK1_PDN        0                  0x0              
 * 0x0012[1:0]   CLK2_IDRV       0                  0x0              
 * 0x0012[3:2]   CLK2_SRC        3                  0x3              
 * 0x0012[4]     CLK2_INV        0                  0x0              
 * 0x0012[5]     MS2_SRC         0                  0x0              
 * 0x0012[6]     MS2_INT         0                  0x0              
 * 0x0012[7]     CLK2_PDN        1                  0x1              
 * 0x0013[1:0]   CLK3_IDRV       0                  0x0              
 * 0x0013[3:2]   CLK3_SRC        3                  0x3              
 * 0x0013[4]     CLK3_INV        0                  0x0              
 * 0x0013[5]     MS3_SRC         0                  0x0              
 * 0x0013[6]     MS3_INT         0                  0x0              
 * 0x0013[7]     CLK3_PDN        1                  0x1              
 * 0x0014[1:0]   CLK4_IDRV       0                  0x0              
 * 0x0014[3:2]   CLK4_SRC        3                  0x3              
 * 0x0014[4]     CLK4_INV        0                  0x0              
 * 0x0014[5]     MS4_SRC         0                  0x0              
 * 0x0014[6]     MS4_INT         0                  0x0              
 * 0x0014[7]     CLK4_PDN        1                  0x1              
 * 0x0015[1:0]   CLK5_IDRV       0                  0x0              
 * 0x0015[3:2]   CLK5_SRC        3                  0x3              
 * 0x0015[4]     CLK5_INV        0                  0x0              
 * 0x0015[5]     MS5_SRC         0                  0x0              
 * 0x0015[6]     MS5_INT         0                  0x0              
 * 0x0015[7]     CLK5_PDN        1                  0x1              
 * 0x0016[1:0]   CLK6_IDRV       0                  0x0              
 * 0x0016[3:2]   CLK6_SRC        3                  0x3              
 * 0x0016[4]     CLK6_INV        0                  0x0              
 * 0x0016[5]     MS6_SRC         0                  0x0              
 * 0x0016[6]     FBA_INT         0                  0x0              
 * 0x0016[7]     CLK6_PDN        1                  0x1              
 * 0x0017[1:0]   CLK7_IDRV       0                  0x0              
 * 0x0017[3:2]   CLK7_SRC        3                  0x3              
 * 0x0017[4]     CLK7_INV        0                  0x0              
 * 0x0017[5]     MS7_SRC         0                  0x0              
 * 0x0017[6]     FBB_INT         0                  0x0              
 * 0x0017[7]     CLK7_PDN        1                  0x1              
 * 0x001C[17:0]  MSNA_P1         3725               0x00E8D          
 * 0x001F[19:0]  MSNA_P2         34136              0x08558          
 * 0x001F[23:4]  MSNA_P3         45000              0x0AFC8          
 * 0x002C[17:0]  MS0_P1          3552               0x00DE0          
 * 0x002F[19:0]  MS0_P2          0                  0x00000          
 * 0x002F[23:4]  MS0_P4          4                  0x00004          
 * 0x0034[17:0]  MS1_P1          3552               0x00DE0          
 * 0x0037[19:0]  MS1_P2          0                  0x00000          
 * 0x0037[23:4]  MS1_P4          4                  0x00004          
 * 0x005A[7:0]   MS6_P2          0                  0x00             
 * 0x005B[7:0]   MS7_P2          0                  0x00             
 * 0x0095[14:0]  SSDN_P2         0                  0x0000           
 * 0x0095[7]     SSC_EN          0                  0x0              
 * 0x0097[14:0]  SSDN_P3         0                  0x0000           
 * 0x0097[7]     SSC_MODE        0                  0x0              
 * 0x0099[11:0]  SSDN_P1         0                  0x000            
 * 0x009A[15:4]  SSUDP           0                  0x000            
 * 0x00A2[21:0]  VCXO_PARAM      0                  0x000000         
 * 0x00A5[7:0]   CLK0_PHOFF      0                  0x00             
 * 0x00A6[7:0]   CLK1_PHOFF      0                  0x00             
 * 0x00B7[7:6]   XTAL_CL         2                  0x2
 * 
 *
 */</span>

<span class="cp">#endif</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Our approach will be to use the header file above as well as the information from <a href="https://www.silabs.com/documents/public/application-notes/AN619.pdf">Application Note AN619</a>. The programming procedure is described in Figure 10 of the <a href="https://www.silabs.com/documents/public/data-sheets/Si5351-B.pdf">data sheet</a>, summarised below.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ClockBuilder Desktop allows a user to generate RAM configuration files to program the Si5351 with custom frequency plans via I2C.  Once the register map has been generated, use the procedure below to program the device.

1. Disable all outputs.
       reg3 = 0xFF
2. Power down all output drivers
       reg 16 = 0x80*
       reg 17 = 0x80*
       reg 18 = 0x80*
       reg 19 = 0x80*
       reg 20 = 0x80*
       reg 21 = 0x80*
       reg 22 = 0x80*
       reg 23 = 0x80*
       * If using the Si5351C with no crystal present on XA/XB, set reg16-23 = 0x84.
3. Set interrupt maks register (see Register 2 description in datasheet)
4. If needed, set crystal load capacitance, XTAL_CL in reg183[7:6].  See datasheet for register description.
5. Write registers 15-92 and 149-170 using the contents of register map generated by ClockBuilder Desktop.
6. Apply PLL A and PLL B soft reset.
       reg177 = 0xAC
7. Enable outputs with OEB control in register 3.
</code></pre></div></div>

<p>If these steps are followed, the output as specified in the include file
should appear. It doesn’t look much like a square wave on my 150 MHz 
bandwidth oscilloscope. Why?</p>

<figure class="">
  <a href="/assets/images/2021/03/si5351-osc.jpg">
  <img src="/assets/images/2021/03/si5351-osc.jpg" alt="" />
  
    <figcaption>
      

    </figcaption></a></figure>

<p>Finally, we wish to have the inphase (I) clock (CLK0) lagging the quadrature (Q) clock (CLK1) by 90 degrees (or 1/4 cycle). We can do this by setting the CLK1_PHOFF register to the appropriate value.</p>

<h1 id="4-laboratory-experiment">4. Laboratory Experiment</h1>
<p>Update the lab files as below.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span><span class="nb">cd </span>elec3607-labquestions/
debian@beaglebone:~/elec3607-labquestions<span class="nv">$ </span>git pull
remote: Enumerating objects: 18, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>18/18<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>12/12<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 14 <span class="o">(</span>delta 2<span class="o">)</span>, reused 14 <span class="o">(</span>delta 2<span class="o">)</span>, pack-reused 0
Unpacking objects: 100% <span class="o">(</span>14/14<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
From https://github.com/phwl/elec3607-labquestions
   6bf3a34..7c881d4  main       -&gt; origin/main
Updating 6bf3a34..7c881d4
Fast-forward
 .DS_Store                                          | Bin 6148 -&gt; 6148 bytes
 labs/.DS_Store                                     | Bin 0 -&gt; 8196 bytes
 ... - GPIO_ ELEC3607 ELEC9607 Embedded Systems.pdf | Bin 0 -&gt; 297484 bytes
 ...ruction_ ELEC3607 ELEC9607 Embedded Systems.pdf | Bin 0 -&gt; 156733 bytes
 ...nerator_ ELEC3607 ELEC9607 Embedded Systems.pdf | Bin 0 -&gt; 2310302 bytes
 labs/lab3-i2c/Makefile                             |   7 +
 labs/lab3-i2c/Si5351A-RevB-Registers.h             | 240 +++++++++++++++++++++
 labs/lab3-i2c/si5351.c                             |  41 ++++
 8 files changed, 288 insertions<span class="o">(</span>+<span class="o">)</span>
 create mode 100644 labs/.DS_Store
 create mode 100644 labs/lab1-gpio/Lab 1 - GPIO_ ELEC3607 ELEC9607 Embedded Systems.pdf
 create mode 100644 labs/lab2-sdrconstruction/Lab 2 - SDR Construction_ ELEC3607 ELEC9607 Embedded Systems.pdf
 create mode 100644 labs/lab3-i2c/Lab 3 - Si5351 Clock Generator_ ELEC3607 ELEC9607 Embedded Systems.pdf
 create mode 100644 labs/lab3-i2c/Makefile
 create mode 100755 labs/lab3-i2c/Si5351A-RevB-Registers.h
 create mode 100644 labs/lab3-i2c/si5351.c
debian@beaglebone:~/elec3607-labquestions<span class="nv">$ </span><span class="nb">cd </span>labs/lab3-i2c/
debian@beaglebone:~/elec3607-labquestions/labs/lab3-i2c<span class="err">$</span>
</code></pre></div></div>
<h3 id="part-1---i2c-interface-30">Part 1 - I2C Interface (30%)</h3>
<p>Connect up your BBG to the Si5351. Verify that you can obtain
the following output.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~$ i2cdetect -y -r 2
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: 60 -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --                         
</code></pre></div></div>

<h3 id="part-2---i2c-transaction-30">Part 2 - I2C Transaction (30%)</h3>
<p>Use the userspace i2c driver (<code class="language-plaintext highlighter-rouge">si5351.c</code>) shown above to read register 0.
Execute the program and capture the activity of the SCL and SDA pins on an oscilloscope. Make a printout of the oscilloscope display and annotate all parts of 
the i2c transaction (start, data, r/w, ack, etc). What is the period of the entire transaction?</p>

<h3 id="part-3---si5351-configuration-40">Part 3 - Si5351 Configuration (40%)</h3>
<p>Modify the userspace driver for the Si5351 to generate a 7 MHz square wave output on CLK0 and CLK1, with CLK1 being delayed by 90 degrees from CLK0.</p>

<h1 id="6-cross-compiling-kernel">6. Cross-compiling Kernel</h1>
<p>This section describes how to cross compile the Beaglebone Black (BBB) or Beaglebone Green (BBG) Linux kernel on an Ubuntu 18.04 Linux machine.</p>

<h2 id="1-introduction">1. Introduction</h2>
<p><strong>Before you proceed, back up your BBB files as we are going to overwrite them!</strong></p>

<p>Although it is possible to develop directly on a Linux embedded
platform, often the machine speed, disk and memory capacity are insufficient for
doing kernel work. Moreover, not all embedded systems have luxuries
such as Ethernet. For these reasons, the normal practice is to
compile on a more powerful host machine. In the descriptions that following, the <code class="language-plaintext highlighter-rouge">$</code> prompt is from the host machine and the <code class="language-plaintext highlighter-rouge">debian@beaglebone:~$</code> prompt is on the BBB.</p>

<p>The system that I am using is <a href="https://releases.ubuntu.com/18.04/">Ubuntu
18.04.5</a>.  Start by installing this on your real or virtual machine.</p>

<p>Also, you should update the Debian distribution on your BBB. Download and flash the <a href="https://beagleboard.org/latest-images">latest image</a>. Boot from an SD card with the latest image by pressing the “User Boot” button while applying power.</p>

<p>Then extend the partition to the same size as the SDcard (the initial partition is 4 GB) by executing.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> /opt/scripts/tools/grow_partition.sh
</code></pre></div></div>
<p>and rebooting.</p>

<h2 id="2-reflash-the-emmc">2. Reflash the eMMC</h2>
<p>If you want to <a href="https://elinux.org/Beagleboard:BeagleBoneBlack_Debian#Flashing_eMMC">reflash the eMMC</a> as well, uncomment the following line in <code class="language-plaintext highlighter-rouge">/boot/uEnv.txt</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmdline=init=/opt/scripts/tools/eMMC/init-eMMC-flasher-v3.sh
</code></pre></div></div>
<p>Then reboot again from the SDcard. After a few tens of seconds, you should see a pattern of the blue LEDs turning on in sequence. After tens of minutes, they will all turn off and your eMMC will have the same image as the SDcard.</p>

<h2 id="2-cross-compilation">2. Cross Compilation</h2>
<p>On the BBB, work out what kernel version is being used:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-r</span>
4.19.94-ti-r42
</code></pre></div></div>

<p>Now install the cross compiler.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>gcc-arm-linux-gnueabi bison flex libssl-dev lzop u-boot-tools
</code></pre></div></div>

<p>Clone the BBB Linux repository and checkout the kernel version you are using. Even if you are planning to upgrade
the kernel, it is a good idea to make sure you can rebuild the original one first.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone git://github.com/beagleboard/linux.git
<span class="nv">$ </span>git checkout 4.19.94-ti-r42
</code></pre></div></div>

<p>This installs installs the initial <code class="language-plaintext highlighter-rouge">.config</code> file for the BB kernel and tells the <code class="language-plaintext highlighter-rouge">make</code> system to use the cross compiler that we installed..</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabi- bb.org_defconfig
</code></pre></div></div>

<p>You can configure the kernel with custom options using the command.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabi- menuconfig
</code></pre></div></div>

<p>While you are there, select the SiLabs 5351A/B/C driver under “Kernel Configuration &gt; Device Drivers &gt; Common Clock Framework” as illustrated below.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.config - Linux/arm 4.19.94 Kernel Configuration
 &gt; Device Drivers &gt; Common Clock Framework                                     
  ┌─sssssssssssssssssssssss Common Clock Framework ─                        ┐
  │  Arrow keys navigate the menu.  &lt;Enter&gt; selects submenus ---&gt; (or empty │  
  │  submenus ----).  Highlighted letters are hotkeys.  Pressing &lt;Y&gt;        │  
  │  includes, &lt;N&gt; excludes, &lt;M&gt; modularizes features.  Press &lt;Esc&gt;&lt;Esc&gt; to │  
  │  exit, &lt;?&gt; for Help, &lt;/&gt; for Search.  Legend: [*] built-in  [ ]         │  
  │ ┌─                                                                    ┐ │  
  │ │    [ ] PLL Driver for HSDK platform                                 │ │  
  │ │    &lt; &gt; Maxim 9485 Programmable Clock Generator                      │ │  
  │ │    &lt;*&gt; Clock driver for SiLabs 5351A/B/C                            │ │  
  │ │    &lt; &gt; Clock driver for SiLabs 514 devices                          │ │  
  │ │    &lt; &gt; Clock driver for SiLabs 544 devices                          │ │  
  │ │    &lt; &gt; Clock driver for SiLabs 570 and compatible devices           │ │  
  │ │    &lt; &gt; Clock driver for TI CDCE706 clock synthesizer                │ │  
  │ │    &lt; &gt; Clock driver for TI CDCE913/925/937/949 devices              │ │  
  │ │    &lt; &gt; Clock driver for CS2000 Fractional-N Clock Synthesizer &amp; Cloc│ │  
  │ │    [ ] Clock driver for Freescale QorIQ platforms                   │ │  
  │ └─   ┴(+)                                                             ┘ │  
  ├─                                                                        ┤  
  │        &lt;Select&gt;    &lt; Exit &gt;    &lt; Help &gt;    &lt; Save &gt;    &lt; Load &gt;         │  
  └─                                                                        ┘  
</code></pre></div></div>

<p>After you finish, exit and save your configuation (it is fine not to make changes at this point). You can
see that what it did was to select the <code class="language-plaintext highlighter-rouge">CONFIG_COMMON_CLK_SI5351</code> option.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep </span>5351 .config
<span class="nv">CONFIG_COMMON_CLK_SI5351</span><span class="o">=</span>y
</code></pre></div></div>

<p>Now cross compile the kernel, specifying the loading address (0x80000000) and that we want to make an image suitable for Uboot (uImage) and to buid all the device tree binaries (dtbs),</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabi- <span class="nv">LOADADDR</span><span class="o">=</span>0x80000000 uImage dtbs
</code></pre></div></div>

<p>Now build the kernel modules.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- modules
</code></pre></div></div>

<p>Then strip and install them all to some temporary directory.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- INSTALL_MOD_STRIP=1 INSTALL_MOD_PATH=/tmp/bbbfs modules_install
</code></pre></div></div>

<h2 id="3-testing-the-new-kernel">3. Testing the new Kernel</h2>
<p>First copy the kernel and modules to the BBB. You will need SDcard storage to include all the modules that are in Linux.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ scp arch/arm/boot/uImage beaglebone.local:
$ scp -r /tmp/bbbfs beaglebone.local:
</code></pre></div></div>

<p>Then move the files into the correct location as root.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~$ mv ~/bbbfs/lib/modules/4.19.94 /lib/modules
debian@beaglebone:~$ mv ~/zImage /boot/vmlinuz-4.19.94
</code></pre></div></div>

<p>Change the kernel that will be used to this one in <code class="language-plaintext highlighter-rouge">/boot/uEnv.txt</code> by modifying the <code class="language-plaintext highlighter-rouge">uname_r</code> 
environment variable.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># uname_r=4.19.94-ti-r42
uname_r=4.19.94
</code></pre></div></div>
<p>and reboot. We can check the new kernel is being used by the build time.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian@beaglebone:~$ cat /proc/version
Linux version 4.19.94 (phwl@bream) (gcc version 7.5.0 (Ubuntu/Linaro 7.5.0-3ubuntu1~18.04)) #1 SMP PREEMPT Wed Mar 24 10:25:30 AEDT 2021
</code></pre></div></div>

<h2 id="4-docker-version">4. Docker version</h2>
<p><a href="https://docs.docker.com/engine/install/ubuntu/">Install docker</a>e (if needed).</p>

<p>```
sudo apt install docker.io
wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.6.15.tar.xz
tar -xf linux-5.6.15.tar.xz
cd linux-5.6.15
docker run –rm dockcross/linux-x64 &gt; ./dockcross
chmod +x dockcross
./dockcross make defconfig
./dockcross make -j 4</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#beaglebone" class="page__taxonomy-item" rel="tag">beaglebone</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#embedded" class="page__taxonomy-item" rel="tag">embedded</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#academia" class="page__taxonomy-item" rel="tag">academia</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-02-22T14:02:12+11:00">February 22, 2021</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=BeagleBone+Green+Getting+Started%20http%3A%2F%2Flocalhost%3A4000%2F2021%2Fbbg-getting-started%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2021%2Fbbg-getting-started%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2021%2Fbbg-getting-started%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2021/lake-eucumbene/" class="pagination--pager" title="Lake Eucumbene - who would go trout fishing during a heatwave?
">Previous</a>
    
    
      <a href="/2021/trailer-bearings/" class="pagination--pager" title="Trailer Bearings
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
      <a href="/2021/if-bit-then/">
        <img src=
          
            "/assets/images/2021/08/cml_logo_new_sm.png"
          
          alt="If-bit-then"></a>
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2021/if-bit-then/" rel="permalink">If-bit-then
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">This optimisation came up in a consulting job for CruxML.
A common pattern in embedded programming or high-level synthesis
is if-bit-then, i.e.  test a bit and modify a variable depending on the re...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
      <a href="/2021/moree-campervan/">
        <img src=
          
            "/assets/images/2021/06/DSCF1070.jpeg"
          
          alt="Moree campervan trip"></a>
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2021/moree-campervan/" rel="permalink">Moree campervan trip
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Hired a Toyota Hiace campervan and went for a drive to Moree via
Muswellbrook and Tamworth.

  
  
  


  
  
  


  
  
  


  
  
  


  
  
  

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
      <a href="/2021/another-balls-head-pano/">
        <img src=
          
            "/assets/images/2021/06/IMG_8091.jpeg"
          
          alt="Another Balls Head Panorama"></a>
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2021/another-balls-head-pano/" rel="permalink">Another Balls Head Panorama
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Nothing much happened the entire morning except for a brief moment when
Beard and I had a double hookup.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
      <a href="/2021/wyong-field-day/">
        <img src=
          
            "/assets/images/2021/05/IMG_7912.jpeg"
          
          alt="Wyong Field Day"></a>
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2021/wyong-field-day/" rel="permalink">Wyong Field Day
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">This was the first time I attended Wyong Field day 2021 “Mayham”.

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
          <li><a href="https://facebook.com/pleong" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
        
      
        
          <li><a href="https://github.com/phwl" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://linkedin.com/in/philip-h-w-leong-949484" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin-f" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 phwl. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
